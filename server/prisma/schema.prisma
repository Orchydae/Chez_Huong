generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  ADMIN
  WRITER
  READER
}

enum ParticularityType {
  VEGETARIAN
  VEGAN
  GLUTEN_FREE
  DAIRY_FREE
  NUT_FREE
  EGG_FREE
  SEAFOOD_FREE
  SOY_FREE
  HALAL
  KOSHER
  LOW_SODIUM
  LOW_SUGAR
  LOW_CARB
  HIGH_PROTEIN
}

model User {
  id        String   @id @default(uuid())
  firstName String
  lastName  String
  email     String   @unique
  password  String
  role      Role

  recipes   Recipe[]
  likes     Like[]
  comments  Comment[]
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum RecipeType {
  BREAKFAST
  MAIN
  SIDE
  DESSERT
  APPETIZER
  SALAD
  SNACK
}

enum TimeUnit {
  MINUTES
  HOURS
}

model Recipe {
  id          Int     @id @default(autoincrement())
  title       String  // Default language (EN)
  title_fr    String? // French translation
  description String? // Default language (EN)
  description_fr String? // French translation
  prepTime    Int // in minutes
  prepTimeUnit TimeUnit @default(MINUTES)
  cookTime    Int // in minutes
  cookTimeUnit TimeUnit @default(MINUTES)
  difficulty  Difficulty
  type        RecipeType
  cuisine     String // e.g., "Vietnamese", "French"
  servings    Int
  
  authorId    String
  author      User    @relation(fields: [authorId], references: [id])

  particularities Particularity[]
  stepSections    StepSection[]
  ingredientSections IngredientSection[]
  likes           Like[]
  comments        Comment[]
}

model IngredientSection {
  id       Int                @id @default(autoincrement())
  name     String  // Default language (EN)
  name_fr  String? // French translation
  recipeId Int
  recipe   Recipe             @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  ingredients RecipeIngredient[]
}

model Particularity {
  id       Int               @id @default(autoincrement())
  recipeId Int
  recipe   Recipe            @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  type     ParticularityType

  @@unique([recipeId, type])
}

model StepSection {
  id       Int    @id @default(autoincrement())
  title    String  // Default language (EN)
  title_fr String? // French translation
  recipeId Int
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  steps    Step[]
}

model Step {
  id            Int         @id @default(autoincrement())
  order         Int
  description   String  // Default language (EN)
  description_fr String? // French translation
  mediaUrl      String?
  stepSectionId Int
  stepSection   StepSection @relation(fields: [stepSectionId], references: [id], onDelete: Cascade)
}

model Ingredient {
  id        Int                  @id @default(autoincrement())
  name      String               @unique
  fdcId     Int?                 @unique // FoodData Central ID (link to USDA)
  recipes   RecipeIngredient[]
  nutrition IngredientNutrition?
  portions  IngredientPortion[]
}

// Stores USDA portion weights for unit-to-gram conversion
// e.g., "1 cup flour = 125g", "1 tbsp butter = 14g"
model IngredientPortion {
  id           Int        @id @default(autoincrement())
  ingredientId Int
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  
  portionName  String     // normalized unit: "cup", "tbsp", "large", "slice"
  gramWeight   Float      // grams per 1 unit of this portion
  
  @@unique([ingredientId, portionName])
}

model IngredientNutrition {
  id            Int        @id @default(autoincrement())
  ingredientId  Int        @unique
  ingredient    Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)

  // Per 100g values (USDA standard)
  servingSize   Float? // in grams

  // Macronutrients
  calories      Float? // kcal
  protein       Float? // g
  carbohydrates Float? // g
  fiber         Float? // g
  sugar         Float? // g

  // Fats (detailed breakdown)
  totalFat      Float? // g
  saturatedFat  Float? // g
  monounsatFat  Float? // g (monounsaturated)
  polyunsatFat  Float? // g (polyunsaturated)
  transFat      Float? // g
  cholesterol   Float? // mg

  // Minerals
  sodium        Float? // mg
  potassium     Float? // mg
  calcium       Float? // mg
  iron          Float? // mg
  magnesium     Float? // mg
  zinc          Float? // mg

  // Vitamins
  vitaminA      Float? // mcg (RAE)
  vitaminC      Float? // mg
  vitaminD      Float? // mcg
  vitaminE      Float? // mg
  vitaminK      Float? // mcg
  vitaminB6     Float? // mg
  vitaminB12    Float? // mcg
  folate        Float? // mcg

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model PendingIngredientMatch {
  id          Int      @id @default(autoincrement())
  searchQuery String   // The original search term
  fdcId       Int      // USDA FoodData Central ID
  name        String   // Food name from USDA
  description String?  // Additional description from USDA
  dataType    String?  // e.g., "Foundation", "SR Legacy", "Branded"
  createdAt   DateTime @default(now())

  @@index([searchQuery])
}

model RecipeIngredient {
  sectionId    Int
  ingredientId Int
  quantity     String
  unit         String

  section    IngredientSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  ingredient Ingredient        @relation(fields: [ingredientId], references: [id], onDelete: Cascade)

  @@id([sectionId, ingredientId])
}

model Like {
  userId   String
  recipeId Int
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@id([userId, recipeId])
}

model Comment {
  id        Int      @id @default(autoincrement())
  content   String
  createdAt DateTime @default(now())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipeId  Int
  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  
  // Reply support - self-referential relation
  parentId  Int?
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")
}


model AuditLog {
  id          Int      @id @default(autoincrement())
  timestamp   DateTime @default(now())
  
  // Who
  userId      String?
  userEmail   String?
  
  // What
  action      String   // e.g., "RECIPE_CREATED", "USER_LOGIN"
  resourceType String  // e.g., "Recipe", "User"
  resourceId  String?
  
  // Details
  metadata    Json?    // Flexible JSON for details
  
  // Context
  ipAddress   String?
  userAgent   String?
  
  @@index([userId])
  @@index([action])
  @@index([resourceType])
  @@index([timestamp])
}
